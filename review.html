
<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>評分頁面</title>

<!-- Common links -->
<!----><link rel="icon" type="image/png" href="/include/icon.png" />
<!----><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<!----><script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<!----><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<!----><script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
<!----><link href="/css/all.css" rel="stylesheet" />
<!----><script src="/js/all.js"></script>
<!---------------------->

<script src="http://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" />

<link rel="stylesheet" href="jquery-ui/jquery-ui.css">
<script type="text/javascript" src="jquery-ui/jquery-ui.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js" type="text/javascript" charset="utf-8"></script>



<style>
html {
  margin:0;
  padding:0;
  overflow-x:hidden;
}

li.tab > a {
	background-color:rgb(60,60,60);
	color:rgb(140,156,156);
}
.tab > a:hover{
	background:rgb(90,90,90) !important;
	border-color:transparent !important;
}
.tab.active > a  {

	background:rgba(50,50,50,1.00) !important;
	color:rgba(225,225,225,1.00) !important;
	border: solid 1px rgb(60,60,55) !important;
	border-bottom-color: transparent;
}
.nav-row {
	background-color: rgb(23,24,20);
}
.nav-tabs {
	border-bottom: solid 1px rgb(60,60,55);
}


/* 這是關於前端小*/
.play {
	background:rgba(50,50,50,1.00);
	height:100%;
	padding:0;
	position:relative;
}
.play iframe {
	position: absolute;
	top: 50%;
	left: 50%;
	margin-right: -50%;
	transform: translate(-50%, -50%)	;
}
.editor-container {
	position:relative;
	height:100%;
	background:rgb(20,20,20);
}
 .editor { 
	margin: 0;
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
}
.showPane{
	height:600px;
	height:-webkit-calc(100vh - 54px); 
	position:relative;
}

.expand {
	width:50%;
	background:rgba(199,199,199,1.00);
	float:left;
}
.source { 
 color:rgba(53,53,53,1.00);
}

.no-padding  {
	padding:0 !important;
}


.grade-preview {
	display:inline;
}

.grading-pane {
	position:absolute;
	
	bottom:0px;;
	left:0px;
	height:80px;
	z-index:10;
}.grading-pane > *{
	display:inline-block;	
}
.star-graded {
	color:red;
}


.-grading-button{
		height:100%;
		border:rgba(0,0,0,1.00) ;
	width:25%;
	float:left;
	background:rgba(196,196,196,1.00);
	color:rgba(0,0,0,1.00);
}


#review-tab{
	padding-top:12px;
}

.control-area{
	position:absolute;
	right:10px;
	padding:5px 0;
	text-align:right;
	
}
input.star{
	display:none;
	
}
.add-bug-img{
	cursor:pointer;
	
}
.bug-img-img{
	position:absolute;
	display:block;
	margin-left: auto;
  margin-right: auto ;
	margin-top:-75px;
	top:50%;
	max-width:100%;
	
}

.fancy {
	width:100%;
	height:100%;
	display:block;
}
.bug-img  {
	max-width: 100%;
	height:150px;
	background-image:url(img/bug.jpg);
	background-size:cover;
	position:relative;
	overflow:hidden;
	padding:0 !important; 
}

.bug-des, .add-bug-des {
		min-height:150px;
		background:rgba(252,204,205,1.00);
}
.bug , .add-bug {
	margin:20px 0 0 0  ;
		min-height:150px;
		padding:0;

}
.add-bug-img {
		min-height:150px;
	background:url(img/photo-upload.jpg);
	background-size:contain;
	background-position:center center;
	background-repeat:no-repeat;
}
</style>


</head>

<body>
<div class="container-fluid">
<div class="modal fade" id="report">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">回報作業問題</h4>
      </div>
      <div class="modal-body">
        <p>發生了什麼事情</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</div>

<style>
.main-nav:hover {
	height:50px !important;

}
</style>
<div class="main-nav" style="  position:relative; height:5px; width:100%; background:rgba(71,176,213,1.00); transition:height .5s;">
</div>
<div class=" container-fluid">
<!-- Nav tabs -->
<div class="nav-row row" style="position:relative;">
<ul id="review-tab" class="nav nav-tabs col-md-12" role="tablist">
  <li class="title disabled"><a>Assign</a></li>
	<li class="tab active">
			<a href="#assign0" role="tab" data-toggle="tab">#1 <div class="badge grade-preview"></div> <span class="glyphicon glyphicon-star preview hidden"></span></a></li>
  <li class="tab"><a href="#assign1" role="tab" data-toggle="tab">#2 <span class="badge grade-preview"></span> <span class="glyphicon glyphicon-star preview hidden"></span></a></li>
  <li class="tab"><a href="#assign2" role="tab" data-toggle="tab">#3 <span class="badge grade-preview"></span> <span class="glyphicon glyphicon-star preview hidden"></span></a></li>
  <li class="tab"><a href="#assign3" role="tab" data-toggle="tab">#4 <span class="badge grade-preview"></span> <span class="glyphicon glyphicon-star preview hidden"></span></a></li>
  <li class="tab"><a href="#assign4" role="tab" data-toggle="tab">#5 <span class="badge grade-preview"></span> <span class="glyphicon glyphicon-star preview hidden"></span></a></li>
</ul>
<div class="control-area col-md-6">

	<div id="requirement-btn"  class="btn" style="color:rgba(212,211,211,1.00);">評分標準<!--span class="glyphicon glyphicon-list"></span--></div>
	<div id="help-review-btn"  class="btn" style="color:rgba(212,211,211,1.00);">如何評分<!--span class="glyphicon glyphicon-question-sign"></span--></div>
	<!--button id="save-grade-btn" type="button" class="btn btn-info"><span class="glyphicon glyphicon-save"></span></button-->

	<button id="review-submit" type="button" class="btn btn-danger btn-lg" onClick="submitReview();"><span class="glyphicon glyphicon-send"></span> 繳交評分結果</button>

</div>
</div>
</div>
<!-- Tab panes -->

<div class="tab-content container-fluid ">
	<!--- next tab --->
  <div  class="tab-pane fade in active" id="assign0">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane col-xs-7">
			<div style="width:40%;">
			<select class=" grade grade-select form-control input-md" >
				<option value="-">選取評等</option>
				<option>A</option>
				<option>B</option>
				<option>C</option>
				<option>X</option>
			</select>
			</div>
			<div class="checkbox" >
				<label style="padding-left:0">
					<button type="button" class="btn btn-default star-btn "><span class="glyphicon glyphicon-star"></span> </button>
					<input class="grade star" type="radio" name="star"  />
				</label>
			</div>
			<div>
			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
			</div>
			<div>
				<button type="button" class="report-btn btn btn-default " data-toggle="modal" data-target="#report"><span class="glyphicon glyphicon-flag"></span></button>
			</div> 
		</div>
				<div class="contaienr">
					<div class="bug-pane">
					<div class="row bug-list">
					</div>
					<form class="add-bug-form" >
						<div class="row add-bug ">
							<div class="add-bug-img col-md-2" >
							</div>
							<input type="file" class="add-img-input hidden" />	
							<div class="add-bug-des col-md-5">
								<textarea  class="add-des-input" ></textarea>
							</div>		
						</div>
						<div class="row">
							<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
						</div>
					</form>
					</div>
					</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade  " id="assign1">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane col-xs-7">
			<div style="width:40%;">
			<select class=" grade grade-select form-control input-md" >
				<option value="-">選取評等</option>
				<option>A</option>
				<option>B</option>
				<option>C</option>
				<option>X</option>
			</select>
			</div>
			<div class="checkbox" >
				<label style="padding-left:0">
					<button type="button" class="btn btn-default star-btn "><span class="glyphicon glyphicon-star"></span> </button>
					<input class="grade star" type="radio" name="star"  />
				</label>
			</div>
			<div>
			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
			</div>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade  " id="assign2">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane col-xs-7">
			<div style="width:40%;">
			<select class=" grade grade-select form-control input-md" >
				<option value="-">選取評等</option>
				<option>A</option>
				<option>B</option>
				<option>C</option>
				<option>X</option>
			</select>
			</div>
			<div class="checkbox" >
				<label style="padding-left:0">
					<button type="button" class="btn btn-default star-btn "><span class="glyphicon glyphicon-star"></span> </button>
					<input class="grade star" type="radio" name="star"  />
				</label>
			</div>
			<div>
			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
			</div>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade  " id="assign3">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane col-xs-7">
			<div style="width:40%;">
			<select class=" grade grade-select form-control input-md" >
				<option value="-">選取評等</option>
				<option>A</option>
				<option>B</option>
				<option>C</option>
				<option>X</option>
			</select>
			</div>
			<div class="checkbox" >
				<label style="padding-left:0">
					<button type="button" class="btn btn-default star-btn "><span class="glyphicon glyphicon-star"></span> </button>
					<input class="grade star" type="radio" name="star"  />
				</label>
			</div>
			<div>
			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
			</div>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade  " id="assign4">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane col-xs-7">
			<div style="width:40%;">
			<select class=" grade grade-select form-control input-md" >
				<option value="-">選取評等</option>
				<option>A</option>
				<option>B</option>
				<option>C</option>
				<option>X</option>
			</select>
			</div>
			<div class="checkbox" >
				<label style="padding-left:0">
					<button type="button" class="btn btn-default star-btn "><span class="glyphicon glyphicon-star"></span> </button>
					<input class="grade star" type="radio" name="star"  />
				</label>
			</div>
			<div>
			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
			</div>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
  
 </div>

<div class="bug-list container-fluid"></div>




</style>

<!--div class="row">
	<div class="one-game container no-padding">
		<div class="expand game">
			<iframe src="final_11/index.html" width="100%" frameborder="0" height="313"></iframe>
		</div>
		<div class="expand source" style="height:313px; overflow:hidden;">
			
		</div>
	</div>
</div-->

<script data-file="grade">


	$(document).on("change",".grade-select",function(){
		var $this = $(this);
		var $p = $this.closest(".tab-pane") ;
		var i = $p.index();
		console.log(i);		
		var g = $this.val();	
		$($(".tab").get(i)).find(".grade-preview").first().text(g)
		gradeArr[i][1] = g ;
		localStorage["gradeArr"] = JSON.stringify (gradeArr);
	} );

  $(document).on('click','.star-btn',function () {
		
		var $this = $(this);
		var radio = $this.siblings('input:radio[name=star]')[0];
		radio.checked = !radio.checked ;

    $('.star-btn').each(function(i, e) {
			if ($(e).siblings('input:radio[name=star]')[0].checked){ //被選了
				$(e).addClass("btn-warning").removeClass("btn-default");
				$($(".tab").get(i)).find(".glyphicon-star.preview").first().removeClass("hidden");
				gradeArr[i][2] = true ;
			}else { // 被取消
				$(e).removeClass("btn-warning").addClass("btn-default");
				$($(".tab").get(i)).find(".glyphicon-star.preview").first().addClass("hidden");
				gradeArr[i][2] = false ;
			}
			localStorage["gradeArr"] = JSON.stringify (gradeArr);

		});
  });

</script>


<script>
$('#review-tab a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});

Parse.initialize("9eo5r1mHWoIPSTCzmrpdKa3lcHPjySx4y5D6q8Nq", "R8SWwYxpJcy73ogQKuSD43y7FigrlDGjBLcy1lzC");	


var currentUser = Parse.User.current();		
//var assignToReview = "1";

//**Rn Test  ---------------**/
var User  = Parse.Object.extend("Test_User");
var qqq = new Parse.Query (User);
qqq.get("x4bNlnkioW").then (function(o){
	currentUser =  o;
	console.log(o);
	console.log (o,o.id);
	$(".add-bug").append(o.id);

	showAssignAndBug ();
	
});
//$('.btn').button();

var AssignArr = [] ;
var CodeArr =  [] ;
var TimeArr = [] ;
var gradeArr = [];
init();

function init (){
	
	//$(".bug-pane").css("display","none");
	
for (var i = 0 ; i < 5; i++){
var tabEditor =  $($(".tab-pane")[i]).find(".editor").first().get(0);
	var editor = ace.edit( tabEditor );
	editor.setTheme("ace/theme/twilight");
	editor.getSession().setUseWrapMode(true);
	editor.getSession().setTabSize(2);
	tabEditor.style.fontSize='14px';
	editor.getSession().setMode("ace/mode/java");
}
//localStorage.clear();
if (localStorage.getItem("gradeArr") !== null){
	console.log (localStorage["gradeArr"],typeof(localStorage["gradeArr"]));
	gradeArr = JSON.parse(localStorage["gradeArr"]);
	console.log("init,local",gradeArr);
	
	showLocal();
	
}else {
	for (var i = 0 ; i < 5 ; i++){
		var arr = ["","-",false];
		gradeArr.push(arr);
	}
}
}

function showLocal (){
	for (var i = 0 ;  i < gradeArr.length ; i++){
		if (gradeArr[i][1] !== '-'){
			var Select = $($(".tab-pane").get(i)).find(".grade-select");
			var opt = Select.find('option:contains("'+gradeArr[i][1]+'")');
			$($(".tab").get(i)).find(".grade-preview").first().text(gradeArr[i][1]);
			opt.attr("selected",true);
			console.log (Select.val());
			Select.val(gradeArr[i][1]);
		}
		if (gradeArr[i][2]){
			var radio = $($(".tab-pane").get(i)).find(".star-btn").click();
		}
	}	
}


///**Rn  end**/



// showAssign ();



var QueryAssigns = function (){
var promise = new Parse.Promise();
var Assign = Parse.Object.extend("Test_Review_Record");
var assign = new Assign();

var q = new Parse.Query(Assign);
console.log(currentUser);
q.equalTo("reviewer",currentUser);
q.equalTo("nth",assignToReview);
//q.include("maker");
q.ascending("createdAt");
q.include("assign");
q.find().then(function(r){
	for (var i = 0 ; i < r.length ; i++) gradeArr[i][0] = r[i].id ;
	AssignArr = r ;
	console.log ("AssignArr",AssignArr);
	promise.resolve(r);
	//console.log("Parse Done, Querying Data..");

},function(e){
	promise.reject(e.message);

	console.log(e.message);
});
	return promise ;
}

function showAssignAndBug(){
	QueryAssigns().then (function(r){
	for (var i = 0 ; i < r.length ; i++){
		var url = 	r[i].get("assign").get("url"); 	
		isInTime(url,i);	
		getCode(url,i); ///
		QueryBug(i);
	}
	},function (e){console.log (e);});
}
function submitReview (e) {
	//checkResult ; /**************************************/
	console.log("click");
	$(this).addClass("disabled");
	var checkStar = false ;
		for (var i = 0 ; i < AssignArr.length ; i++){
			var g  =  gradeArr [i] ;
			if (g[1] === "-"){ alert("#"+(i+1)+" 還沒評等喔！"); return false}	
			AssignArr[i].set("grade",g[1]);
			AssignArr[i].set("star",g[2]);
			AssignArr[i].set("overtime",TimeArr[i]);
			if (g[2]){checkStar = true ;}
		}
		if (!checkStar){alert("你還沒挑選最佳解喔！");
		return false}
		if (confirm("確定要繳交了嗎?繳交後就不能再更改囉")){
			$(this).attr("disabled","disabled");
			Parse.Object.saveAll(AssignArr).then (function (re){
				console.log ("SaveResult",re);
				localStorage.clear();
				alert("繳交成功了!");
			},function(e){
				console.log ("e");
			});
		}
}


function isInTime(url,i){
	console.log("Check Last Modified...");
		$.ajax({
			url : "lastModify.php",
			async : false,
			type: "POST",
			data:{url:url},
			dataType : 'text', //explicitly requesting the xml as text, rather than an xml document
			success : function (data, status, xhr) {	
			  data = JSON.parse(data);
				console.log ("time",data['timenum']);
				var t = Math.round(new Date().getTime() / 1000);
				console.log ("t",t);
				TimeArr[i] = data ;
				var play = document.createElement("iframe");
				play.frameBorder = 0 ;
				play.style.width = "600px";
				play.style.height = "400px";
				play.setAttribute("src",url);
				$($(".tab-pane")[i]).find(".play").first().html(play);
			}
		});
}

</script>



<script data-file="這是程式預覽" >

function getCode (url,i){
		console.log("Ajaxing");
		$.ajax({
			url : "getcode.php",
			async : true,
			type: "POST",
			data:{url:url},
			dataType : 'text', //explicitly requesting the xml as text, rather than an xml document
			success : function (data, status, xhr) {		
				if (status == 'success') {
					var tabEditor =  $($(".tab-pane")[i]).find(".editor").first().get(0);
					//console.log(tabEditor);
					var editor = ace.edit( tabEditor );
			//		editor.setTheme("ace/theme/twilight");
			//		editor.getSession().setUseWrapMode(true);
			//		editor.getSession().setTabSize(2);
			//		tabEditor.style.fontSize='14px';
			//		editor.getSession().setMode("ace/mode/java");
					editor.setValue(data);
					CodeArr[i] = data ;				
				}	
			}
		});
}



</script>
<script data-file="Bug">

$(document).on('click',".togglebug",function(){	
	$bugArea = $(".tab-content .active .bug-pane");
	if ($bugArea.is(":hidden")) {
		$bugArea.toggle("blind");
		$('html, body').animate({
     scrollTop: $bugArea.offset().top
    }, 400);
	}else {
		$(".toTop").trigger("click");
		$bugArea.toggle( "blind" );
	}
});

 /**var a = '<div class="row bug">
**/

function QueryBug (i){
var BugRecord = Parse.Object.extend("Test_Bug_Record");
var q = new Parse.Query (BugRecord);
q.equalTo("assign",AssignArr[i].get("assign").id);
q.include("reviewer");
q.ascending("createdAt");
q.find().then(function(r){
	for ( var j = 0 ; j < r.length ; j++ ){
		var b = r[j] ;
		apdBug(i,b);
	}
	},function(e){console.log(e);
});
}


function apdBug(i,b){
		var reviewer = b.get("reviewer");
		var des = b.get("des");
		var imgUrl = b.get("img").url();
		var time = b.createdAt;
		//console.log ("bugi" , i ,des);
		var html =	'<div id="'+b.id+'" class="bug container-fluid">\
				<!--div class="bug-reviewer col-md-1">'+reviewer.get("name")+'</div-->\
				<div class="bug-img col-md-2"><a class="fancy" tabindex="10" href="'+imgUrl+'"><img class="bug-img-img" src="'+imgUrl+'" /></a>'+'</div>\
				<div class="bug-des col-md-5">'+""+'</div>\
				<div class="bug-time">'+time+'</div>\
			</div>';
	//	$(html).find(".bug-des").first().text(des);
		$($(".tab-pane")[i]).find(".bug-list").append(html);
		$("#"+b.id).find(".bug-des").text(des);
}

$(".bug-pane").on("focusin", function(){
	console.log("fuck");
	
$("a.fancy").fancybox({
		'transitionIn'	:	'elastic',
		'transitionOut'	:	'elastic',
		'speedIn'		:	600, 
		'speedOut'		:	200, 
		'overlayShow'	:	false,
		'type' : "image"
	});
});

$(document).on('click','.add-bug-img',function(e){
	$(this).siblings("input:file.add-img-input").first().trigger('click');
});



//Rn

$("input:file.add-img-input")	.change(function () {				
			var $p = $(this).closest(".tab-pane") ;

				var reader =  new  FileReader ();
				 reader.onload = function (e) {
					 var i = new Image ();
				      i.src = e.target.result ;
					var finalWitdh = 800 ;
					var finalHeight =  i.naturalHeight  /i.naturalWidth * finalWitdh   ;
 							$ ( i ). css ( 'width' , finalWitdh+'px' )	;		
          //  $("body").append(i);
					var cvs = document.createElement ( 'canvas' );
					cvs.width = finalWitdh ;
					cvs.height = finalHeight;
				  var ctx = cvs.getContext( "2d" ).drawImage( i,0,0,finalWitdh,finalHeight);
					var newImageData = cvs.toDataURL ( "image/jpeg" , .6 );
					var result_image_obj =  new  Image ();
             result_image_obj.src = newImageData ;

            $p.find('.add-bug-img').first().css('background-image', 'url('+newImageData+')');

         //   $("body").append(result_image_obj);
					$('.add-bug-img').data("base64",newImageData.replace("data:image/jpeg;base64,", ""));
						 //console.log (base64);
				 }
				reader.readAsDataURL ( this.files[0] );			
});




</script>

<script data-file="pull-Bug">



$(document).on('click',".submit-bug",function (e){
//檢查BUg 是否新增完成	
	e.preventDefault();
	console.log ("true");
var $p = $(this).closest(".tab-pane") ;
var i = $p.index();
var form = $p.find(".add-bug").get(0);;
var $img = $p.find(".add-img-input").first();
var $preImg = $p.find(".add-bug-img")
var base64 = $preImg.data("base64");

var $btn = $p.find(".submit-bug").first();
console.log($img);
var des = $p.find(".add-des-input").first().val();

var fileUploadControl = $img[0];

if(des.length < 10 ){ 
	alert("你的描述太過精簡，請至少超過十個字。"); 
	return false ;}

if (fileUploadControl.files.length > 0) {


	if (Validate(form)){
		$btn.attr("disabled","disabled");

		var BugRecord = Parse.Object.extend("Test_Bug_Record");
		var bugRecord = new BugRecord();
	
		var file = fileUploadControl.files[0];
		var name = file.name;
		var bugImg = new Parse.File("Bug",{base64:base64});
		//http://stackoverflow.com/questions/4459379/preview-an-image-before-it-is-uploaded
		bugImg.save().then(function(img){
			console.log(img);
			bugRecord.set("reviewer",currentUser);
			bugRecord.set("assign",AssignArr[i].get("assign").id);
			bugRecord.set("img",img);
			bugRecord.set("des",des);
			return bugRecord.save();
		}).then (function(bugRecord){
			console.log(bugRecord);
			apdBug (i,bugRecord);
			$p.find(".add-bug-form").trigger('reset');
			$preImg.removeAttr("style");
			$btn.removeAttr("disabled");
		},function(e){console.log(e);});
	}else { // file is not image;
		$img.trigger('click');
	}
}else { // if 沒有點選附檔
	alert("請附上Bug圖片");
}
	return false ;
});



</script>
<script type="text/javascript" data-source="http://stackoverflow.com/questions/4234589/validation-of-file-extension-before-uploading-file">

function Validate(oForm) {
		var _validFileExtensions = [".jpg", ".jpeg", ".bmp", ".gif", ".png"];
    var arrInputs = oForm.getElementsByTagName("input");
    for (var i = 0; i < arrInputs.length; i++) {
        var oInput = arrInputs[i];
        if (oInput.type == "file") {
            var sFileName = oInput.value;
            if (sFileName.length > 0) {
                var blnValid = false;
                for (var j = 0; j < _validFileExtensions.length; j++) {
                    var sCurExtension = _validFileExtensions[j];
                    if (sFileName.substr(sFileName.length - sCurExtension.length, sCurExtension.length).toLowerCase() == sCurExtension.toLowerCase()) {
                        blnValid = true;
                        break;
                    }
                }
                if (!blnValid) {
                    alert("抱歉" + sFileName +"不符合格式！請重新選擇圖檔！ \n 允許格式：JPG,PNG,BMP,GIF");// + _validFileExtensions.join(", "));
                    return false;
                }
            }
        }
    }

    return true;
}
</script>


</body>
</html>
