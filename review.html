<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>評分頁面</title>

<!-- Common links -->
<!----><link rel="icon" type="image/png" href="/include/icon.png" />
<!----><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<!----><script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<!----><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<!----><script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
<!----><link href="/css/all.css" rel="stylesheet" />
<!----><script src="/js/all.js"></script>
<!---------------------->

<link rel="stylesheet" href="jquery-ui/jquery-ui.css">
<script type="text/javascript" src="jquery-ui/jquery-ui.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js" type="text/javascript" charset="utf-8"></script>



<style>
html {
  margin:0;
  padding:0;
  overflow-x:hidden;
}
.play {
	background:gray;
	height:100%;
	padding:0;
	position:relative;
}
.play iframe {
	position: absolute;
	top: 50%;
	left: 50%;
	margin-right: -50%;
	transform: translate(-50%, -50%)	;
}
.editor-container {
	position:relative;
	height:100%;
	
}
 .editor { 
	margin: 0;
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
}
.showPane{
	height:600px;
	height:-webkit-calc(100vh - 54px); 
	position:relative;
}

.expand {
	width:50%;
	background:rgba(199,199,199,1.00);
	float:left;
}
.source { 
 color:rgba(53,53,53,1.00);
}

.no-padding  {
	padding:0 !important;
}


.grade-preview {
	display:inline;
}

.grading-pane {
	position:absolute;
	
	bottom:0px;;
	left:0px;
	height:80px;
	z-index:10;
}.grading-pane * {
	float:left;
	margin: 0 20px;
}
.star-graded {
	color:red;
	
}


.-grading-button{
		height:100%;
		border:rgba(0,0,0,1.00) ;
	width:25%;
	float:left;
	background:rgba(196,196,196,1.00);
	color:rgba(0,0,0,1.00);
}

#review-submit-block{
	position:absolute;
	right:10px;
	top:4px;
}
#review-tab{
	padding-top:12px;
}

</style>


</head>

<body>	
<div class=" container-fluid">
<!-- Nav tabs -->
<div class="row" style="position:relative;">
<ul id="review-tab" class="nav nav-tabs col-md-12" role="tablist">
  <li class="title disabled"><a >Assign</a></li>
	<li class="tab active">
			<a href="#assign0" role="tab" data-toggle="tab">#1 <div class="grade-preview"></div></a></li>
  <li class="tab" ><a href="#assign1" role="tab" data-toggle="tab">#2 <div class="grade-preview"></div></a></li>
  <li class="tab"><a href="#assign2" role="tab" data-toggle="tab">#3 <div class="grade-preview"></div></a></li>
  <li class="tab"><a href="#assign3" role="tab" data-toggle="tab">#4 <div class="grade-preview"></div></a></li>
  <li class="tab"><a href="#assign4" role="tab" data-toggle="tab">#5 <div class="grade-preview"></div></a></li>
</ul>
<div id="review-submit-block" class="col-md-2">
	<button id="review-submit" class="btn btn-primary btn-lg" onClick="submitReview();">確認繳交</button>
</div>
</div>
</div>
<!-- Tab panes -->

<div class="tab-content container-fluid ">
	<!--- next tab --->
  <div  class="tab-pane fade in active" id="assign0">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane">
			<select class=" grade grade-select form-control input-md" >
				<option>-</option>
				<option>O</option>
				<option>C</option>
				<option>B</option>
				<option>A</option>
			</select>
			<div class="checkbox">
				<label>
					<input class="grade star" type="checkbox">是否為最佳解
				</label>
			</div>

			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="bug-reviewer col-md-1"></div>
				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade in " id="assign1">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane">
			<select class=" grade grade-select form-control input-md" >
				<option>-</option>
				<option>O</option>
				<option>C</option>
				<option>B</option>
				<option>A</option>
			</select>
			<div class="checkbox">
				<label>
					<input class="grade star" type="checkbox">是否為最佳解
				</label>
			</div>

			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="bug-reviewer col-md-1"></div>

				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade in " id="assign2">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane">
			<select class=" grade grade-select form-control input-md" >
				<option>-</option>
				<option>O</option>
				<option>C</option>
				<option>B</option>
				<option>A</option>
			</select>
			<div class="checkbox">
				<label>
					<input class="grade star" type="checkbox">是否為最佳解
				</label>
			</div>

			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="bug-reviewer col-md-1"></div>

				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade in " id="assign3">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane">
			<select class=" grade grade-select form-control input-md" >
				<option>-</option>
				<option>O</option>
				<option>C</option>
				<option>B</option>
				<option>A</option>
			</select>
			<div class="checkbox">
				<label>
					<input class="grade star" type="checkbox">是否為最佳解
				</label>
			</div>

			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="bug-reviewer col-md-1"></div>

				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>
	<!--- next tab --->
  <div  class="tab-pane fade in " id="assign4">
		<div class="row showPane">
			<div class="play col-xs-7"></div>
			<div class="editor-container col-xs-5">
				<div class="editor"></div>
			</div>
		</div>
		<div class="grading-pane">
			<select class=" grade grade-select form-control input-md" >
				<option>-</option>
				<option>O</option>
				<option>C</option>
				<option>B</option>
				<option>A</option>
			</select>
			<div class="checkbox">
				<label>
					<input class="grade star" type="checkbox">是否為最佳解
				</label>
			</div>

			<button type="button" class="btn btn-danger togglebug" >顯示霸個</button>
		</div>
		
		<div class="bug-pane">
		<div class="row bug-list">
		</div>
		<form class="add-bug-form" >
			<div class="row add-bug ">
				<div class="bug-reviewer col-md-1"></div>
				<div class="add-bug-img col-md-2">
					<input type="file" class="add-img-input" />	
				</div>
				<div class="add-bug-des col-md-5">
				 	<textarea  class="add-des-input" ></textarea>
				</div>		
			</div>
			<div class="row">
				<button type="button" class="submit-bug btn btn-danger col-md-offset-6 col-md-1" >呈交霸個</button>
			</div>
		</form>
		</div>
	</div>


 </div>
<style>
.bug-img  {
	min-height:150px;
	background-image:url(img/bug.jpg);
	background-size:cover;
}

.bug-des, .add-bug-des {
		min-height:150px;
		background:rgba(252,204,205,1.00);
}
.bug , .add-bug {
	margin:20px 0 0 0  ;
		min-height:150px;


}
.add-bug-img {
		min-height:150px;

	background:url(img/photo-upload.jpg);
	background-size:contain;
	background-position:center center;
	background-repeat:no-repeat;
}
</style>
<div class="bug-list container-fluid"></div>



<div class="toTop">

</style>

<!--div class="row">
	<div class="one-game container no-padding">
		<div class="expand game">
			<iframe src="final_11/index.html" width="100%" frameborder="0" height="313"></iframe>
		</div>
		<div class="expand source" style="height:313px; overflow:hidden;">
			
		</div>
	</div>
</div-->

<script>


$('#review-tab a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
})


/*
$(document).on("mouseover",".game", function (){
	$(this).animate({width:"60%"},300);
	
	$(this).siblings(".source").animate({width:"40%"},300);
	//alert ("yes");
});

$(document).on("mouseover",".source", function (){
	$(this).animate({width:"60%"},300);
	$(this).siblings(".game").animate({width:"40%"},300);
});
*/
Parse.initialize("9eo5r1mHWoIPSTCzmrpdKa3lcHPjySx4y5D6q8Nq", "R8SWwYxpJcy73ogQKuSD43y7FigrlDGjBLcy1lzC");	


var currentUser = Parse.User.current();		
var assignToReview = "1";

//**Rn Test  ---------------**/
var User  = Parse.Object.extend("Test_User");
var qqq = new Parse.Query (User);
qqq.get("x4bNlnkioW").then (function(o){
	currentUser =  o;
	console.log(o);
	showAssignAndBug ();
	init(o);
});
function init (o){
	$(".add-bug").append("<img src='"+ o.id+"'>");
	localStorage ;
	$(".bug-pane").css("display","none");
}


///**Rn  end**/



// showAssign ();



var AssignArr = [] ;

var QueryAssigns = function (){
var promise = new Parse.Promise();
var Assign = Parse.Object.extend("Test_Review_Record");
var assign = new Assign();

var q = new Parse.Query(Assign);
console.log(currentUser);
q.equalTo("reviewer",currentUser);
q.equalTo("nth",assignToReview);
//q.include("maker");
q.ascending("createdAt");
q.include("assign");
q.find().then(function(r){
	AssignArr = r ;
	promise.resolve(r);
	//console.log("Parse Done, Querying Data..");

},function(e){
	promise.reject(e.message);

	console.log(e.message);
});
	return promise ;
}

function showAssignAndBug(){
	QueryAssigns().then (function(r){
	for (var i = 0 ; i < r.length ; i++){
		console.log(r[i].get("assign").get("url"));
		isInTime(	r[i].get("assign").get("url"),i);	
		QueryBug(i);
	}
	},function (e){console.log (e);});
	
	
}
function submitReview (e) {
	//checkResult ; /**************************************/
	console.log("click");
	$(this).addClass("disabled");
	QueryAssigns().then (function(r){	
		for (var i = 0 ; i < r.length ; i++){
			var g  = gradeArr [i];
			r[i].set("grade",g[1]);
			r[i].set("star",g[2]);
		}
		Parse.Object.saveAll(r).then (function (re){
			console.log ("SaveResult",re);
		},function(e){
			console.log ("e")
		});
	},function (ee){console.log (ee);});
}


function isInTime(url,i){
	console.log("Check Last Modified...");
		$.ajax({
			url : "lastModify.php",
			async : false,
			type: "POST",
			data:{url:url},
			dataType : 'text', //explicitly requesting the xml as text, rather than an xml document
			success : function (data, status, xhr) {	
				console.log (data);
				getCode(url,i); ///
				var play = document.createElement("iframe");
				play.style.width = "600px";
				play.style.height = "400px";
				play.setAttribute("src",url);
				$($(".tab-pane")[i]).find(".play").first().html(play);
			}
		});
}

</script>

<script data-file="grade">

var gradeArr = [];
for (var i = 0 ; i < 5 ; i++){
	var arr = ["","-",false];
	gradeArr.push(arr);
}

	$(document).on("change",".grade",function(){
		var $this = $(this);
		var $p = $this.closest(".tab-pane") ;
		var i = $p.index();
		console.log(i);		
		if ($this.hasClass("grade-select")){
			var g = $this.val();	
			console.log($($(".tab").get(i)).find(".grade-preview").first().text(g));
			gradeArr[i][1] = g ;
		}else if ($this.hasClass("star")){
			var g = $(this).is(":checked") ;
			gradeArr[i][2] = g ;
			console.log ("g",g);
			if (g){
				$(".star").each(function(j, e) {
					console.log("$(e).is($this)",$(e).is($this));
					if ($(e).is($this)){
						$($(".tab").get(i)).find(".grade-preview").first().addClass("star-graded");			
						return true;
					}else{
						gradeArr[j][2] = false ;
						$(e).prop('checked', false);
						var $pp = $(e).closest(".tab-pane") ;
						var ii = $pp.index();
						$($(".tab").get(ii)).find(".grade-preview").first().removeClass("star-graded");
						$(e).val(false);
					}
				});
			}else {
				$($(".tab").get(i)).find(".grade-preview").first().removeClass("star-graded");
			}
		}
		console.log (gradeArr);
	} );
</script>


<script data-file="這是程式預覽" >

function getCode (url,i){
		console.log("Ajaxing");
		$.ajax({
			url : "/getcode.php",
			async : true,
			type: "POST",
			data:{url:url},
			dataType : 'text', //explicitly requesting the xml as text, rather than an xml document
			success : function (data, status, xhr) {		
				if (status == 'success') {
					var tabEditor =  $($(".tab-pane")[i]).find(".editor").first().get(0);
					console.log(tabEditor);
					var editor = ace.edit( tabEditor );
					editor.setTheme("ace/theme/twilight");
					editor.getSession().setUseWrapMode(true);
					editor.getSession().setTabSize(2);
					tabEditor.style.fontSize='14px';
					editor.getSession().setMode("ace/mode/java");
					editor.setValue(data);
				}	
			}
		});
}



</script>
<script data-file="Bug">

$(document).on('click',".togglebug",function(){	
	$bugArea = $(".tab-content .active .bug-pane");
	if ($bugArea.is(":hidden")) {
		$bugArea.toggle("blind");
		$('html, body').animate({
     scrollTop: $bugArea.offset().top
    }, 400);
	}else {
		$(".toTop").trigger("click");
		$bugArea.toggle( "blind" );
	}
});

 /**var a = '<div class="row bug">
**/

function QueryBug (i){
var BugRecord = Parse.Object.extend("Test_Bug_Record");
var q = new Parse.Query (BugRecord);
q.equalTo("assign",AssignArr[i]);
q.include("reviewer");
q.descending("createdAt");
q.find().then(function(r){
	for ( var j = 0 ; j < r.length ; j++ ){
		var b = r[j] ;
		ppdBug(i,b);		
	}
	},function(e){console.log(e);
	
});
function ppdBug(i,b){
		var reviewer = b.get("reviewer");
		var des = b.get("des");
		var imgUrl = b.get("img").url();
		var time = b.createdAt;
		var html =	'<div class="bug container-fluid">\
				<div class="bug-reviewer col-md-1">'+reviewer.get("name")+'</div>\
				<div class="bug-img col-md-2" style="background-image:url('+imgUrl+');">'+'</div>\
				<div class="bug-des col-md-5">'+des+'</div>\
				<div class="bug-time">'+time+'</div>\
			</div>';
		$($(".tab-pane")[i]).find(".bug-list").prepend(html);
}


}

</script>

<script data-file="pull-Bug">



$(document).on('click',".submit-bug",function (e){
	e.preventDefault();
	console.log ("true");
var BugRecord = Parse.Object.extend("Test_Bug_Record");
var bugRecord = new BugRecord();


var $p = $(this).closest(".tab-pane") ;
var i = $p.index();
var $img = $p.find(".add-img-input").first();
console.log($img);
var des = $p.find(".add-des-input").first().val();

var fileUploadControl = $img[0];
if (fileUploadControl.files.length > 0) {
  var file = fileUploadControl.files[0];
  var name = file.name;
  var bugImg = new Parse.File("Bug",file);
	bugImg.save().then(function(img){
		console.log(img);
		bugRecord.set("reviewer",currentUser);
		bugRecord.set("assign",AssignArr[i]);
		bugRecord.set("img",img);
		bugRecord.set("des",des);
		return bugRecord.save();
	}).then (function(bugRecord){
		console.log(bugRecord);
		ppdBug (i,bugRecord);
	},function(e){console.log(e);});
	}
	return false ;
});
</script>


</body>
</html>
